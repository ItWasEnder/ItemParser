name: Publish (GitHub Packages)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g. 1.3.1). If omitted, uses the tag name without leading 'v'."
        required: false
        type: string
  push:
    tags:
      - "v*"

permissions:
  contents: read
  packages: write

# Avoid duplicate publishes for the same version (e.g. manual reruns).
concurrency:
  group: publish-${{ inputs.version || github.ref_name }}
  cancel-in-progress: true

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Determine version
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "${{ inputs.version || '' }}" ]]; then
            v="${{ inputs.version }}"
          else
            v="${GITHUB_REF_NAME}"
          fi
          v="${v#v}"
          if [[ -z "$v" ]]; then
            echo "Version could not be determined." >&2
            exit 1
          fi
          echo "version=$v" >> "$GITHUB_OUTPUT"

      - name: Log publish context (no secrets)
        shell: bash
        run: |
          set -euo pipefail
          echo "event_name=${{ github.event_name }}"
          echo "ref=${{ github.ref }}"
          echo "ref_name=${{ github.ref_name }}"
          echo "inputs.version=${{ inputs.version || '' }}"
          echo "resolved.version=${{ steps.ver.outputs.version }}"

      - name: "Preflight: check if version already exists in GitHub Packages (no secrets)"
        id: preflight
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.ver.outputs.version }}
        shell: bash
        run: |
          set -euo pipefail
          url="https://maven.pkg.github.com/${GITHUB_REPOSITORY}/tv/ender/itemparser/itemparser/${VERSION}/itemparser-${VERSION}.jar"
          code="$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer ${GITHUB_TOKEN}" -L "$url" || true)"
          echo "preflight.http_code=$code"
          if [[ "$code" == "200" ]]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish to GitHub Packages
        if: steps.preflight.outputs.exists != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ORG_GRADLE_PROJECT_releaseVersion: ${{ steps.ver.outputs.version }}
        run: ./gradlew publishMavenJavaPublicationToGitHubPackagesRepository --no-daemon --stacktrace --info


